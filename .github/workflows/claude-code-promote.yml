name: Claude Code promote

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Bare semver to promote (example: 2.1.29)"
        required: true
        type: string
      dry_run:
        description: "Set true to validate and stage changes without opening a PR"
        required: true
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  promote:
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ inputs.version }}
      DRY_RUN: ${{ inputs.dry_run }}
      ROOT: cli_manifests/claude_code
      REQUIRED_TARGET: linux-x64-musl
      ASSET: claude
      BIN: ./claude-linux-x64-musl
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dtolnay/rust-toolchain@stable

      - name: Install musl runtime (linux-x64-musl)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y musl musl-tools

      - name: Validate inputs and required files
        shell: bash
        run: |
          set -euo pipefail
          [[ "$VERSION" =~ ^[0-9]+\\.[0-9]+\\.[0-9]+$ ]]
          test -f "${ROOT}/snapshots/${VERSION}/union.json"
          test -f "${ROOT}/artifacts.lock.json"

      - name: Acquire pinned Claude Code CLI (required target)
        shell: bash
        run: |
          set -euo pipefail
          URL="$(jq -r --arg v "$VERSION" --arg t "$REQUIRED_TARGET" --arg a "$ASSET" '.artifacts[] | select(.claude_code_version==$v and .target_triple==$t and .asset_name==$a) | .download_url' "${ROOT}/artifacts.lock.json")"
          SHA="$(jq -r --arg v "$VERSION" --arg t "$REQUIRED_TARGET" --arg a "$ASSET" '.artifacts[] | select(.claude_code_version==$v and .target_triple==$t and .asset_name==$a) | .sha256' "${ROOT}/artifacts.lock.json")"
          SIZE="$(jq -r --arg v "$VERSION" --arg t "$REQUIRED_TARGET" --arg a "$ASSET" '.artifacts[] | select(.claude_code_version==$v and .target_triple==$t and .asset_name==$a) | .size_bytes' "${ROOT}/artifacts.lock.json")"
          test -n "$URL" && test "$URL" != "null"
          test -n "$SHA" && test "$SHA" != "null"
          test -n "$SIZE" && test "$SIZE" != "null"

          curl -fsSL -o claude.bin "$URL"
          test "$(wc -c < claude.bin)" = "$SIZE"
          echo "$SHA  claude.bin" | sha256sum -c -
          install -m 0755 claude.bin "$BIN"
          DISABLE_AUTOUPDATER=1 "$BIN" --version

      - name: Run Linux checks (required target)
        shell: bash
        run: |
          set -euo pipefail
          cargo test -p claude_code

      - name: Promote pointers and metadata
        shell: bash
        run: |
          set -euo pipefail

          printf '%s\\n' "$VERSION" > "${ROOT}/latest_validated.txt"
          printf '%s\\n' "$VERSION" > "${ROOT}/pointers/latest_validated/${REQUIRED_TARGET}.txt"
          cp "${ROOT}/snapshots/${VERSION}/union.json" "${ROOT}/current.json"

          if [ ! -f "${ROOT}/versions/${VERSION}.json" ]; then
            cargo run -p xtask -- \
              codex-version-metadata \
              --version "$VERSION" \
              --status reported \
              --root "${ROOT}"
          fi

          jq \
            --arg t "$REQUIRED_TARGET" \
            '.validation = {"passed_targets":[ $t ], "failed_targets":[], "skipped_targets":[]}' \
            "${ROOT}/versions/${VERSION}.json" > "${ROOT}/versions/${VERSION}.json.tmp"
          mv "${ROOT}/versions/${VERSION}.json.tmp" "${ROOT}/versions/${VERSION}.json"

          cargo run -p xtask -- \
            codex-version-metadata \
            --version "$VERSION" \
            --status validated \
            --root "${ROOT}"

      - name: Validate promoted artifacts (hard gate)
        shell: bash
        run: |
          set -euo pipefail
          cargo run -p xtask -- codex-validate --root "${ROOT}"

      - name: Render promotion summary
        shell: bash
        run: |
          set -euo pipefail
          {
            echo "## Claude Code promotion"
            echo ""
            echo "- promoted version: \\`${VERSION}\\`"
            echo "- required target: \\`${REQUIRED_TARGET}\\`"
            echo "- dry run: \\`${DRY_RUN}\\`"
          } > _claude_code_promote_summary.md

      - name: Create promotion PR
        if: ${{ env.DRY_RUN != 'true' }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.AUTOMATION_TOKEN || secrets.GITHUB_TOKEN }}
          commit-message: "chore: promote claude code ${VERSION}"
          title: "chore: promote claude code ${VERSION}"
          body-path: _claude_code_promote_summary.md
          branch: "automation/claude-code-promote-${{ inputs.version }}"
          delete-branch: true
