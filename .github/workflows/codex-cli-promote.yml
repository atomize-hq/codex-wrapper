name: Codex CLI promote

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Bare semver to promote (example: 0.92.0)"
        required: true
        type: string
      dry_run:
        description: "Set true to validate and stage changes without opening a PR"
        required: true
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  promote:
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ inputs.version }}
      DRY_RUN: ${{ inputs.dry_run }}
      ROOT: cli_manifests/codex
      REQUIRED_TARGET: x86_64-unknown-linux-musl
      ASSET: codex-x86_64-unknown-linux-musl.tar.gz
      BIN: ./codex-x86_64-unknown-linux-musl
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dtolnay/rust-toolchain@stable

      - name: Validate inputs and required files
        shell: bash
        run: |
          set -euo pipefail
          [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]
          test -f "${ROOT}/snapshots/${VERSION}/union.json"
          test -f "${ROOT}/artifacts.lock.json"

      - name: Acquire pinned Codex CLI (required target)
        shell: bash
        run: |
          set -euo pipefail
          URL="$(jq -r --arg v "$VERSION" --arg t "$REQUIRED_TARGET" --arg a "$ASSET" '.artifacts[] | select(.codex_version==$v and .target_triple==$t and .asset_name==$a) | .download_url' "${ROOT}/artifacts.lock.json")"
          SHA="$(jq -r --arg v "$VERSION" --arg t "$REQUIRED_TARGET" --arg a "$ASSET" '.artifacts[] | select(.codex_version==$v and .target_triple==$t and .asset_name==$a) | .sha256' "${ROOT}/artifacts.lock.json")"
          SIZE="$(jq -r --arg v "$VERSION" --arg t "$REQUIRED_TARGET" --arg a "$ASSET" '.artifacts[] | select(.codex_version==$v and .target_triple==$t and .asset_name==$a) | .size_bytes' "${ROOT}/artifacts.lock.json")"
          test -n "$URL" && test "$URL" != "null"
          test -n "$SHA" && test "$SHA" != "null"
          test -n "$SIZE" && test "$SIZE" != "null"

          curl -fsSL -o codex.tgz "$URL"
          test "$(wc -c < codex.tgz)" = "$SIZE"
          echo "$SHA  codex.tgz" | sha256sum -c -
          MEMBER="$(tar -tzf codex.tgz | awk 'NF && substr($0,length($0),1) != "/" {print; exit}')"
          test -n "$MEMBER"
          rm -rf _extract
          mkdir -p _extract
          tar -xzf codex.tgz -C _extract "$MEMBER"
          install -m 0755 "_extract/$MEMBER" "$BIN"
          "$BIN" --version

      - name: Run Linux validated checks (required target)
        shell: bash
        run: |
          set -euo pipefail
          export CODEX_E2E_HOME="$(mktemp -d)"
          export CODEX_HOME="$CODEX_E2E_HOME"
          export CODEX_BINARY="$BIN"
          export CODEX_E2E_BINARY="$BIN"
          cargo test -p codex
          cargo test -p codex --examples
          cargo run -p codex --example feature_detection
          cargo run -p codex --example capability_snapshot -- "$CODEX_BINARY" "$CODEX_E2E_HOME/capabilities.json" auto
          cargo test -p codex --test cli_e2e -- --nocapture

      - name: Promote pointers and metadata
        shell: bash
        run: |
          set -euo pipefail

          printf '%s\n' "$VERSION" > "${ROOT}/latest_validated.txt"
          printf '%s\n' "$VERSION" > "${ROOT}/pointers/latest_validated/${REQUIRED_TARGET}.txt"
          cp "${ROOT}/snapshots/${VERSION}/union.json" "${ROOT}/current.json"

          if [ ! -f "${ROOT}/versions/${VERSION}.json" ]; then
            cargo run -p xtask -- \
              codex-version-metadata \
              --version "$VERSION" \
              --status reported \
              --root "${ROOT}"
          fi

          jq \
            --arg t "$REQUIRED_TARGET" \
            '.validation = {"passed_targets":[ $t ], "failed_targets":[], "skipped_targets":[]}' \
            "${ROOT}/versions/${VERSION}.json" > "${ROOT}/versions/${VERSION}.json.tmp"
          mv "${ROOT}/versions/${VERSION}.json.tmp" "${ROOT}/versions/${VERSION}.json"

          cargo run -p xtask -- \
            codex-version-metadata \
            --version "$VERSION" \
            --status validated \
            --root "${ROOT}"

      - name: Validate promoted artifacts (hard gate)
        shell: bash
        run: |
          set -euo pipefail
          cargo run -p xtask -- codex-validate --root "${ROOT}"

      - name: Render promotion summary
        shell: bash
        run: |
          set -euo pipefail
          {
            echo "## Codex CLI promotion"
            echo ""
            echo "- promoted version: \`${VERSION}\`"
            echo "- required target: \`${REQUIRED_TARGET}\`"
            echo "- dry run: \`${DRY_RUN}\`"
          } > _codex_cli_promote_summary.md

      - name: Create promotion PR
        if: ${{ env.DRY_RUN != 'true' }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.AUTOMATION_TOKEN || github.token }}
          commit-message: "chore: promote codex cli ${VERSION}"
          title: "chore: promote codex cli ${VERSION}"
          body-path: _codex_cli_promote_summary.md
          branch: "automation/codex-cli-promote-${{ inputs.version }}"
          delete-branch: true

