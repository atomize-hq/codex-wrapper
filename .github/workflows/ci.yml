name: CI

on:
  pull_request:
    branches:
      - staging
      - main
  push:
    branches:
      - main
      - feat/codex-cli-parity
  workflow_dispatch:

permissions:
  contents: read

jobs:
  pr-purpose:
    name: PR purpose (staging -> main)
    runs-on: ubuntu-latest
    outputs:
      purpose: ${{ steps.purpose.outputs.purpose }}
    steps:
      - name: Determine purpose label
        id: purpose
        shell: bash
        run: |
          set -euo pipefail
          # Only meaningful for pull_request events (especially staging -> main).
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "purpose=non_pr" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "${{ github.base_ref }}" != "main" ] || [ "${{ github.head_ref }}" != "staging" ]; then
            echo "purpose=non_staging_to_main" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          labels="$(jq -r '.pull_request.labels[].name' "$GITHUB_EVENT_PATH" || true)"
          purpose=""
          for l in $labels; do
            case "$l" in
              purpose=codex_release) purpose="codex_release" ;;
              purpose=claude_code_release) purpose="claude_code_release" ;;
              purpose=ops) purpose="ops" ;;
              *) ;;
            esac
          done

          if [ -z "$purpose" ]; then
            echo "purpose=missing" >> "$GITHUB_OUTPUT"
            echo "Missing required purpose label (should be enforced by only-staging-to-main.yml)." >&2
            exit 1
          fi
          echo "purpose=$purpose" >> "$GITHUB_OUTPUT"

  rust-tests:
    name: Rust tests (workspace)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: cargo test --workspace
        shell: bash
        run: |
          set -euo pipefail
          cargo test --workspace --all-targets

  codex-validate-artifacts:
    name: Validate Codex committed artifacts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - id: codex-artifacts
        name: Detect Codex committed artifacts
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=(cli_manifests/codex/versions/*.json)
          if (( ${#files[@]} > 0 )); then
            echo "has_versions=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_versions=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip (no Codex artifacts committed yet)
        if: ${{ steps.codex-artifacts.outputs.has_versions != 'true' }}
        shell: bash
        run: echo "No cli_manifests/codex/versions/*.json; skipping codex-validate."

      - uses: dtolnay/rust-toolchain@stable
        if: ${{ steps.codex-artifacts.outputs.has_versions == 'true' }}

      - name: xtask codex-validate
        if: ${{ steps.codex-artifacts.outputs.has_versions == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          cargo run -p xtask -- codex-validate --root cli_manifests/codex

  claude-validate-artifacts:
    name: Validate Claude Code committed artifacts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: xtask codex-validate (claude_code root)
        shell: bash
        run: |
          set -euo pipefail
          cargo run -p xtask -- codex-validate --root cli_manifests/claude_code

  versions:
    name: Read Codex version pointers
    runs-on: ubuntu-latest
    outputs:
      latest_validated: ${{ steps.versions.outputs.latest_validated }}
      min_supported: ${{ steps.versions.outputs.min_supported }}
    steps:
      - uses: actions/checkout@v4
      - id: versions
        shell: bash
        run: |
          set -euo pipefail
          echo "latest_validated=$(tr -d '\n' < cli_manifests/codex/latest_validated.txt)" >> "$GITHUB_OUTPUT"
          echo "min_supported=$(tr -d '\n' < cli_manifests/codex/min_supported.txt)" >> "$GITHUB_OUTPUT"

  claude-versions:
    name: Read Claude Code version pointers
    runs-on: ubuntu-latest
    outputs:
      latest_validated: ${{ steps.versions.outputs.latest_validated }}
    steps:
      - uses: actions/checkout@v4
      - id: versions
        shell: bash
        run: |
          set -euo pipefail
          echo "latest_validated=$(tr -d '\n' < cli_manifests/claude_code/latest_validated.txt)" >> "$GITHUB_OUTPUT"

  linux-latest-validated:
    name: Linux (latest validated)
    runs-on: ubuntu-latest
    needs: [versions, pr-purpose]
    if: ${{ !(github.event_name == 'push' && github.ref_name == 'main') && (github.event_name != 'pull_request' || github.base_ref != 'main' || needs.pr-purpose.outputs.purpose == 'codex_release') }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Acquire Codex CLI
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.versions.outputs.latest_validated }}"
          TARGET="x86_64-unknown-linux-musl"
          ASSET="codex-${TARGET}.tar.gz"

          URL="$(jq -r --arg v "$VERSION" --arg t "$TARGET" --arg a "$ASSET" '.artifacts[] | select(.codex_version==$v and .target_triple==$t and .asset_name==$a) | .download_url' cli_manifests/codex/artifacts.lock.json)"
          SHA="$(jq -r --arg v "$VERSION" --arg t "$TARGET" --arg a "$ASSET" '.artifacts[] | select(.codex_version==$v and .target_triple==$t and .asset_name==$a) | .sha256' cli_manifests/codex/artifacts.lock.json)"
          SIZE="$(jq -r --arg v "$VERSION" --arg t "$TARGET" --arg a "$ASSET" '.artifacts[] | select(.codex_version==$v and .target_triple==$t and .asset_name==$a) | .size_bytes' cli_manifests/codex/artifacts.lock.json)"

          test -n "$URL" && test "$URL" != "null"
          test -n "$SHA" && test "$SHA" != "null"
          test -n "$SIZE" && test "$SIZE" != "null"

          curl -fsSL -o codex.tgz "$URL"
          test "$(wc -c < codex.tgz)" = "$SIZE"
          echo "$SHA  codex.tgz" | sha256sum -c -
          MEMBER="$(tar -tzf codex.tgz | awk 'NF && substr($0,length($0),1) != "/" {print; exit}')"
          test -n "$MEMBER"
          rm -rf _extract
          mkdir -p _extract
          tar -xzf codex.tgz -C _extract "$MEMBER"
          install -m 0755 "_extract/$MEMBER" ./codex-x86_64-unknown-linux-musl
          ./codex-x86_64-unknown-linux-musl --version

      - name: Validated checks (real binary)
        shell: bash
        run: |
          set -euo pipefail
          export CODEX_E2E_HOME="$(mktemp -d)"
          export CODEX_HOME="$CODEX_E2E_HOME"
          export CODEX_BINARY=./codex-x86_64-unknown-linux-musl
          cargo test -p codex
          cargo test -p codex --examples
          cargo run -p codex --example feature_detection
          cargo run -p codex --example capability_snapshot -- "$CODEX_BINARY" "$CODEX_E2E_HOME/capabilities.json" auto
          CODEX_E2E_BINARY=./codex-x86_64-unknown-linux-musl cargo test -p codex --test cli_e2e -- --nocapture

  linux-min-supported:
    name: Linux (min supported)
    runs-on: ubuntu-latest
    needs: [versions, pr-purpose]
    if: ${{ !(github.event_name == 'push' && github.ref_name == 'main') && (needs.versions.outputs.min_supported != needs.versions.outputs.latest_validated) && (github.event_name != 'pull_request' || github.base_ref != 'main' || needs.pr-purpose.outputs.purpose == 'codex_release') }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Acquire Codex CLI
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.versions.outputs.min_supported }}"
          TARGET="x86_64-unknown-linux-musl"
          ASSET="codex-${TARGET}.tar.gz"

          URL="$(jq -r --arg v "$VERSION" --arg t "$TARGET" --arg a "$ASSET" '.artifacts[] | select(.codex_version==$v and .target_triple==$t and .asset_name==$a) | .download_url' cli_manifests/codex/artifacts.lock.json)"
          SHA="$(jq -r --arg v "$VERSION" --arg t "$TARGET" --arg a "$ASSET" '.artifacts[] | select(.codex_version==$v and .target_triple==$t and .asset_name==$a) | .sha256' cli_manifests/codex/artifacts.lock.json)"
          SIZE="$(jq -r --arg v "$VERSION" --arg t "$TARGET" --arg a "$ASSET" '.artifacts[] | select(.codex_version==$v and .target_triple==$t and .asset_name==$a) | .size_bytes' cli_manifests/codex/artifacts.lock.json)"

          test -n "$URL" && test "$URL" != "null"
          test -n "$SHA" && test "$SHA" != "null"
          test -n "$SIZE" && test "$SIZE" != "null"

          curl -fsSL -o codex.tgz "$URL"
          test "$(wc -c < codex.tgz)" = "$SIZE"
          echo "$SHA  codex.tgz" | sha256sum -c -
          MEMBER="$(tar -tzf codex.tgz | awk 'NF && substr($0,length($0),1) != "/" {print; exit}')"
          test -n "$MEMBER"
          rm -rf _extract
          mkdir -p _extract
          tar -xzf codex.tgz -C _extract "$MEMBER"
          install -m 0755 "_extract/$MEMBER" ./codex-x86_64-unknown-linux-musl
          ./codex-x86_64-unknown-linux-musl --version

      - name: Validated checks (real binary)
        shell: bash
        run: |
          set -euo pipefail
          export CODEX_E2E_HOME="$(mktemp -d)"
          export CODEX_HOME="$CODEX_E2E_HOME"
          export CODEX_BINARY=./codex-x86_64-unknown-linux-musl
          cargo test -p codex
          cargo test -p codex --examples
          cargo run -p codex --example feature_detection
          cargo run -p codex --example capability_snapshot -- "$CODEX_BINARY" "$CODEX_E2E_HOME/capabilities.json" auto
          CODEX_E2E_BINARY=./codex-x86_64-unknown-linux-musl cargo test -p codex --test cli_e2e -- --nocapture

  linux-claude-latest-validated:
    name: Claude Code Linux (latest validated)
    runs-on: ubuntu-latest
    needs: [claude-versions, pr-purpose]
    if: ${{ !(github.event_name == 'push' && github.ref_name == 'main') && needs.claude-versions.outputs.latest_validated != 'none' && (github.event_name != 'pull_request' || github.base_ref != 'main' || needs.pr-purpose.outputs.purpose == 'claude_code_release') }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Acquire Claude Code CLI (required target)
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.claude-versions.outputs.latest_validated }}"
          TARGET="linux-x64"
          ASSET="claude"

          URL="$(jq -r --arg v "$VERSION" --arg t "$TARGET" --arg a "$ASSET" '.artifacts[] | select(.claude_code_version==$v and .target_triple==$t and .asset_name==$a) | .download_url' cli_manifests/claude_code/artifacts.lock.json)"
          SHA="$(jq -r --arg v "$VERSION" --arg t "$TARGET" --arg a "$ASSET" '.artifacts[] | select(.claude_code_version==$v and .target_triple==$t and .asset_name==$a) | .sha256' cli_manifests/claude_code/artifacts.lock.json)"
          SIZE="$(jq -r --arg v "$VERSION" --arg t "$TARGET" --arg a "$ASSET" '.artifacts[] | select(.claude_code_version==$v and .target_triple==$t and .asset_name==$a) | .size_bytes' cli_manifests/claude_code/artifacts.lock.json)"

          test -n "$URL" && test "$URL" != "null"
          test -n "$SHA" && test "$SHA" != "null"
          test -n "$SIZE" && test "$SIZE" != "null"

          curl -fsSL -o claude.bin "$URL"
          test "$(wc -c < claude.bin)" = "$SIZE"
          echo "$SHA  claude.bin" | sha256sum -c -
          install -m 0755 claude.bin ./claude-linux-x64
          DISABLE_AUTOUPDATER=1 ./claude-linux-x64 --version

      - name: Wrapper unit tests
        shell: bash
        run: |
          set -euo pipefail
          cargo test -p claude_code
