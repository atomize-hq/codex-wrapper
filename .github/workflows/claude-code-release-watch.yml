name: Claude Code release watch

on:
  schedule:
    - cron: "31 3 * * *"
  workflow_dispatch:

permissions:
  contents: read
  actions: write

jobs:
  watch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            const bucketRoot = "https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases";

            function parseStrictStableSemver(s) {
              if (!s) return null;
              const m = String(s).trim().match(/^(\d+)\.(\d+)\.(\d+)$/);
              if (!m) return null;
              return { version: `${m[1]}.${m[2]}.${m[3]}`, nums: [Number(m[1]), Number(m[2]), Number(m[3])] };
            }

            function cmpSemverDesc(a, b) {
              for (let i = 0; i < 3; i++) {
                if (a.nums[i] !== b.nums[i]) return b.nums[i] - a.nums[i];
              }
              return 0;
            }

            const stableText = await (await fetch(`${bucketRoot}/stable`)).text();
            const stable = parseStrictStableSemver(stableText);
            if (!stable) {
              core.setFailed(`Invalid stable pointer from ${bucketRoot}/stable: ${stableText}`);
              return;
            }

            const latestValidatedRaw = fs.readFileSync("cli_manifests/claude_code/latest_validated.txt", "utf8").trim();
            const latestValidated = parseStrictStableSemver(latestValidatedRaw);

            core.info(`stable=${stable.version} latest_validated=${latestValidated ? latestValidated.version : latestValidatedRaw}`);

            if (latestValidated && cmpSemverDesc(stable, latestValidated) >= 0) {
              core.info("Stable is not newer than latest_validated; nothing to do.");
              return;
            }

            core.info(`Dispatching claude-code-update-snapshot.yml for version=${stable.version}`);
            const ref = context.ref.startsWith("refs/heads/")
              ? context.ref.slice("refs/heads/".length)
              : context.ref;

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "claude-code-update-snapshot.yml",
              ref,
              inputs: { version: stable.version },
            });
