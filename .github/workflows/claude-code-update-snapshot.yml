name: Claude Code update snapshot

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Bare semver (example: 2.1.29)"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare:
    name: Prepare pins (artifacts.lock.json)
    runs-on: ubuntu-latest
    outputs:
      source_date_epoch: ${{ steps.manifest.outputs.source_date_epoch }}
      snapshot_matrix: ${{ steps.matrix.outputs.snapshot_matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Fetch manifest + compute SOURCE_DATE_EPOCH
        id: manifest
        shell: bash
        env:
          VERSION: ${{ inputs.version }}
          BUCKET: "https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases"
        run: |
          set -euo pipefail
          curl -fsSL "${BUCKET}/${VERSION}/manifest.json" > manifest.json
          BUILD_DATE="$(jq -r '.buildDate' manifest.json)"
          test -n "$BUILD_DATE" && test "$BUILD_DATE" != "null"
          SOURCE_DATE_EPOCH="$(date -d "$BUILD_DATE" +%s)"
          echo "source_date_epoch=${SOURCE_DATE_EPOCH}" >> "$GITHUB_OUTPUT"

      - name: Compute snapshot matrix from RULES.json (union.expected_targets)
        id: matrix
        shell: bash
        run: |
          set -euo pipefail
          RULES="cli_manifests/claude_code/RULES.json"

          entries=()
          while IFS= read -r target; do
            case "$target" in
              linux-x64-musl)
                entries+=("{\"target_triple\":\"$target\",\"runs_on\":\"ubuntu-latest\",\"asset_name\":\"claude\",\"binary_path\":\"./claude-$target\"}")
                ;;
              darwin-arm64)
                entries+=("{\"target_triple\":\"$target\",\"runs_on\":\"macos-latest\",\"asset_name\":\"claude\",\"binary_path\":\"./claude-$target\"}")
                ;;
              win32-x64)
                entries+=("{\"target_triple\":\"$target\",\"runs_on\":\"windows-latest\",\"asset_name\":\"claude.exe\",\"binary_path\":\"./claude-$target.exe\"}")
                ;;
              *)
                echo "Unsupported target_triple in ${RULES} union.expected_targets: ${target}" >&2
                exit 1
                ;;
            esac
          done < <(jq -r '.union.expected_targets[]' "$RULES")

          printf '%s\n' "${entries[@]}" | jq -c -s '{include: .}' > snapshot_matrix.json
          echo "snapshot_matrix=$(cat snapshot_matrix.json)" >> "$GITHUB_OUTPUT"

      - name: Download artifacts + update lockfile
        shell: bash
        env:
          VERSION: ${{ inputs.version }}
          BUCKET: "https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases"
        run: |
          set -euo pipefail

          curl -fsSL "${BUCKET}/${VERSION}/manifest.json" > manifest.json

          jq '.include | map({target_triple, asset_name, binary_path})' snapshot_matrix.json > targets.json

          mkdir -p _download
          jq -c '.[]' targets.json | while read -r row; do
            TARGET="$(jq -r '.target_triple' <<<"$row")"
            ASSET="$(jq -r '.asset_name' <<<"$row")"
            URL="${BUCKET}/${VERSION}/${TARGET}/${ASSET}"

            EXPECTED_SHA="$(jq -r --arg t "$TARGET" '.platforms[$t].checksum // empty' manifest.json)"
            EXPECTED_SIZE="$(jq -r --arg t "$TARGET" '.platforms[$t].size // empty' manifest.json)"
            test -n "$EXPECTED_SHA" && test "$EXPECTED_SHA" != "null"
            test -n "$EXPECTED_SIZE" && test "$EXPECTED_SIZE" != "null"

            OUT="_download/${TARGET}-${ASSET}"
            curl -fsSL -o "$OUT" "$URL"
            SIZE_BYTES="$(wc -c < "$OUT" | tr -d ' ')"
            SHA256="$(sha256sum "$OUT" | awk '{print $1}')"

            test "$SHA256" = "$EXPECTED_SHA"
            test "$SIZE_BYTES" = "$EXPECTED_SIZE"

            jq -n \
              --arg v "$VERSION" \
              --arg t "$TARGET" \
              --arg asset "$ASSET" \
              --arg url "$URL" \
              --arg sha "$SHA256" \
              --argjson size "$SIZE_BYTES" \
              '{claude_code_version:$v, target_triple:$t, asset_name:$asset, download_url:$url, sha256:$sha, size_bytes:$size}' \
              > "_download/${TARGET}.artifact.json"
          done

          jq -s '.' _download/*.artifact.json > artifact.json

          jq \
            --arg v "$VERSION" \
            --slurpfile new artifact.json \
            '
              .schema_version = 1
              | .upstream.channel = "stable"
              | .artifacts = (
                  ( .artifacts // [] )
                  | map(select(.claude_code_version != $v))
                  + $new[0]
                  | unique_by([.claude_code_version, .target_triple])
                  | sort_by([(.claude_code_version|split(".")|map(tonumber)), .target_triple])
                )
            ' \
            cli_manifests/claude_code/artifacts.lock.json > artifacts.lock.json.tmp
          mv artifacts.lock.json.tmp cli_manifests/claude_code/artifacts.lock.json

      - name: Upload pins + downloads
        uses: actions/upload-artifact@v4
        with:
          name: "claude-code-pins-${{ inputs.version }}"
          if-no-files-found: error
          path: |
            cli_manifests/claude_code/artifacts.lock.json
            _download/

  snapshot:
    name: "Snapshot (${{ matrix.target_triple }})"
    needs: prepare
    runs-on: ${{ matrix.runs_on }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.prepare.outputs.snapshot_matrix) }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Install musl runtime (linux-x64-musl)
        if: ${{ matrix.target_triple == 'linux-x64-musl' }}
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y musl musl-tools

      - name: Download pins + downloads
        uses: actions/download-artifact@v4
        with:
          name: "claude-code-pins-${{ inputs.version }}"
          path: .

      - name: Acquire pinned Claude Code CLI
        shell: bash
        env:
          VERSION: ${{ inputs.version }}
          TARGET: ${{ matrix.target_triple }}
          ASSET: ${{ matrix.asset_name }}
          BIN: ${{ matrix.binary_path }}
        run: |
          set -euo pipefail
          URL="$(jq -r --arg v "$VERSION" --arg t "$TARGET" --arg a "$ASSET" '.artifacts[] | select(.claude_code_version==$v and .target_triple==$t and .asset_name==$a) | .download_url' cli_manifests/claude_code/artifacts.lock.json)"
          SHA="$(jq -r --arg v "$VERSION" --arg t "$TARGET" --arg a "$ASSET" '.artifacts[] | select(.claude_code_version==$v and .target_triple==$t and .asset_name==$a) | .sha256' cli_manifests/claude_code/artifacts.lock.json)"
          SIZE="$(jq -r --arg v "$VERSION" --arg t "$TARGET" --arg a "$ASSET" '.artifacts[] | select(.claude_code_version==$v and .target_triple==$t and .asset_name==$a) | .size_bytes' cli_manifests/claude_code/artifacts.lock.json)"
          test -n "$URL" && test "$URL" != "null"
          test -n "$SHA" && test "$SHA" != "null"
          test -n "$SIZE" && test "$SIZE" != "null"

          FILE="_download/${TARGET}-${ASSET}"
          test -f "$FILE"

          python -c 'import hashlib, sys; p=sys.argv[1]; exp_sha=sys.argv[2]; exp_size=int(sys.argv[3]); b=open(p,"rb").read(); got_sha=hashlib.sha256(b).hexdigest(); got_size=len(b); assert got_sha==exp_sha, f"sha256 mismatch: expected={exp_sha} got={got_sha}"; assert got_size==exp_size, f"size mismatch: expected={exp_size} got={got_size}"; print(f"ok: {p} sha256={got_sha} size_bytes={got_size}")' "$FILE" "$SHA" "$SIZE"

          if [[ "$ASSET" == "claude.exe" ]]; then
            cp "$FILE" "$BIN"
          else
            install -m 0755 "$FILE" "$BIN"
          fi

          DISABLE_AUTOUPDATER=1 "$BIN" --version

      - name: Generate per-target snapshot (+ raw help)
        shell: bash
        env:
          VERSION: ${{ inputs.version }}
          TARGET: ${{ matrix.target_triple }}
          BIN: ${{ matrix.binary_path }}
          SOURCE_DATE_EPOCH: ${{ needs.prepare.outputs.source_date_epoch }}
        run: |
          set -euo pipefail
          OUT="cli_manifests/claude_code/snapshots/${VERSION}/${TARGET}.json"
          cargo run -p xtask -- \
            claude-snapshot \
            --claude-binary "$BIN" \
            --out-file "$OUT" \
            --capture-raw-help \
            --raw-help-target "$TARGET" \
            --supplement cli_manifests/claude_code/supplement/commands.json

      - name: Upload snapshot JSON
        uses: actions/upload-artifact@v4
        with:
          name: "claude-code-snapshot-${{ inputs.version }}-${{ matrix.target_triple }}"
          if-no-files-found: error
          path: |
            cli_manifests/claude_code/snapshots/${{ inputs.version }}/${{ matrix.target_triple }}.json

      - name: Upload raw help capture (not committed)
        uses: actions/upload-artifact@v4
        with:
          name: "claude-code-raw-help-${{ inputs.version }}-${{ matrix.target_triple }}"
          if-no-files-found: error
          path: |
            cli_manifests/claude_code/raw_help/${{ inputs.version }}/${{ matrix.target_triple }}/

  union-report-validate:
    name: Union → Report → Validate (Linux)
    runs-on: ubuntu-latest
    needs: [prepare, snapshot]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Download pins + downloads
        uses: actions/download-artifact@v4
        with:
          name: "claude-code-pins-${{ inputs.version }}"
          path: .

      - name: Download required Linux snapshot
        uses: actions/download-artifact@v4
        with:
          name: "claude-code-snapshot-${{ inputs.version }}-linux-x64-musl"
          path: .

      - name: Download macOS snapshot (best effort)
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: "claude-code-snapshot-${{ inputs.version }}-darwin-arm64"
          path: .

      - name: Download Windows snapshot (best effort)
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: "claude-code-snapshot-${{ inputs.version }}-win32-x64"
          path: .

      - name: Union
        shell: bash
        env:
          VERSION: ${{ inputs.version }}
          SOURCE_DATE_EPOCH: ${{ needs.prepare.outputs.source_date_epoch }}
        run: |
          set -euo pipefail
          cargo run -p xtask -- claude-union --root cli_manifests/claude_code --version "$VERSION"

      - name: Wrapper coverage + reports + validate
        shell: bash
        env:
          VERSION: ${{ inputs.version }}
          SOURCE_DATE_EPOCH: ${{ needs.prepare.outputs.source_date_epoch }}
        run: |
          set -euo pipefail
          cargo run -p xtask -- claude-wrapper-coverage --out cli_manifests/claude_code/wrapper_coverage.json
          cargo run -p xtask -- codex-report --root cli_manifests/claude_code --version "$VERSION"
          cargo run -p xtask -- codex-version-metadata --root cli_manifests/claude_code --version "$VERSION" --status reported
          cargo run -p xtask -- codex-validate --root cli_manifests/claude_code

      - name: Generate triad scaffold from report
        shell: bash
        env:
          VERSION: ${{ inputs.version }}
        run: |
          set -euo pipefail
          OUT="docs/project_management/next/claude-code-cli-parity-${VERSION}"
          cargo run -p xtask -- parity-triad-scaffold --root cli_manifests/claude_code --version "$VERSION" --out "$OUT"

      - name: Render summary
        shell: bash
        env:
          VERSION: ${{ inputs.version }}
        run: |
          set -euo pipefail
          {
            echo "## Claude Code snapshot update"
            echo ""
            echo "- version: \`${VERSION}\`"
            echo "- parity root: \`cli_manifests/claude_code\`"
          } > _claude_code_update_summary.md

      - name: Create update PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.AUTOMATION_TOKEN || secrets.GITHUB_TOKEN }}
          commit-message: "chore: snapshot claude code ${VERSION}"
          title: "chore: snapshot claude code ${VERSION}"
          body-path: _claude_code_update_summary.md
          branch: "automation/claude-code-${{ inputs.version }}"
          delete-branch: true
