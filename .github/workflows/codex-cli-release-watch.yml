name: Codex CLI release watch

on:
  schedule:
    - cron: "17 3 * * *"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  watch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            function parseSemverFromTag(tagName) {
              if (!tagName || !tagName.startsWith("rust-v")) return null;
              const v = tagName.slice("rust-v".length);
              const parts = v.split(".");
              if (parts.length !== 3) return null;
              const nums = parts.map((p) => Number(p));
              if (nums.some((n) => Number.isNaN(n))) return null;
              return { version: v, nums };
            }

            function cmpSemverDesc(a, b) {
              for (let i = 0; i < 3; i++) {
                if (a.nums[i] !== b.nums[i]) return b.nums[i] - a.nums[i];
              }
              return 0;
            }

            const upstream = { owner: "openai", repo: "codex" };
            const allReleases = await github.paginate(github.rest.repos.listReleases, {
              ...upstream,
              per_page: 100,
            });

            const stable = allReleases
              .filter((r) => r && r.tag_name && r.draft === false && r.prerelease === false)
              .map((r) => ({ release: r, semver: parseSemverFromTag(r.tag_name) }))
              .filter((r) => r.semver !== null)
              .sort((a, b) => cmpSemverDesc(a.semver, b.semver));

            if (stable.length === 0) {
              core.setFailed("No stable upstream releases found for openai/codex with tags like rust-v<semver>.");
              return;
            }

            const latestStable = stable[0].semver.version;
            const candidate = (stable[1] ?? stable[0]).semver.version;
            const latestValidated = fs.readFileSync("cli_manifests/codex/latest_validated.txt", "utf8").trim();

            core.info(`latest_validated=${latestValidated} latest_stable=${latestStable} candidate=${candidate}`);
            if (candidate === latestValidated) {
              core.info("Candidate matches latest_validated; nothing to do.");
              return;
            }

            const title = `Codex CLI release watch: candidate ${candidate}`;
            const releaseUrl = (v) => `https://github.com/openai/codex/releases/tag/rust-v${v}`;
            const workflowUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/workflows/codex-cli-update-snapshot.yml`;
            const body =
              `Upstream Codex CLI release watch detected a new candidate.\n\n` +
              `- latest_validated: ${latestValidated}\n` +
              `- latest_stable: ${latestStable} (${releaseUrl(latestStable)})\n` +
              `- candidate (stable-minus-one): ${candidate} (${releaseUrl(candidate)})\n\n` +
              `Checklist:\n` +
              `- [ ] Run Update Snapshot workflow: ${workflowUrl}\n` +
              `  - version: ${candidate}\n` +
              `  - update_min_supported: false (unless policy bump is intended)\n`;

            const search = await github.rest.search.issuesAndPullRequests({
              q: `repo:${context.repo.owner}/${context.repo.repo} is:issue is:open in:title "${title}"`,
            });

            if (search.data.items.length > 0) {
              const issueNumber = search.data.items[0].number;
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                title,
                body,
              });
              core.info(`Updated issue #${issueNumber}: ${title}`);
              return;
            }

            const created = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
            });
            core.info(`Created issue #${created.data.number}: ${title}`);

